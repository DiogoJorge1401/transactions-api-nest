import { NestFactory, Reflector } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { ThrottlerGuard } from '@nestjs/throttler';
import helmet from 'helmet';
import { Logger } from 'nestjs-pino';
import { AppModule } from './app.module';
import { NestExpressApplication } from '@nestjs/platform-express';

async function bootstrap() {
  const app = await NestFactory.create<NestExpressApplication>(AppModule, { bufferLogs: true });

  app.set('trust proxy', 'loopback');

  app.useLogger(app.get(Logger));

  app.use(helmet());

  app.enableCors();

  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
    }),
  );

  const config = new DocumentBuilder()
    .setTitle('Transaction Statistics API')
    .setDescription('A RESTful API that receives transactions and returns statistics based on those transactions')
    .setVersion('1.0')
    .addTag('Transactions', 'Transaction management endpoints')
    .addTag('Statistics', 'Transaction statistics endpoints')
    .addTag('Health', 'Health check endpoints')
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);

  const port = process.env.PORT || 3000;
  await app.listen(port);

  console.log(`ðŸš€ Application is running on: http://localhost:${port}`);
  console.log(`ðŸ“š Swagger documentation available at: http://localhost:${port}/api/docs`);
  console.log(`ðŸ’š Health check available at: http://localhost:${port}/health`);
}
bootstrap();
